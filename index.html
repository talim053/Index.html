<!DOCTYPE html>
<html>
<head>
    <title>Location-Based Data Form</title>
</head>
<body>
    <h2>Data Submission Form</h2>
    <p id="locationStatus" style="color: red;">Checking location...</p>
    <form id="userForm" style="display: none;">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required><br><br>
        
        <label for="gender">Gender:</label>
        <select id="gender" name="gender" required>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
        </select><br><br>
        
        <label for="age">Age:</label>
        <input type="number" id="age" name="age" required><br><br>
        
        <button type="submit">Submit</button>
    </form>
    <p id="confirmation" style="color: green; display: none;">Data Sent Successfully!</p>
    <p id="error" style="color: red; display: none;">Error sending data.</p>
    
    <script>
        const allowedLatitude = 28.22315741881459;
        const allowedLongitude = 77.09913041100037;
        const allowedRadius = 200; // in meters

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            function deg2rad(deg) {
                return deg * (Math.PI / 180);
            }
            var R = 6371000; // Radius of the Earth in meters
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var distance = R * c;
            return distance;
        }

        function checkLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    const distance = getDistanceFromLatLonInMeters(userLat, userLon, allowedLatitude, allowedLongitude);
                    
                    if (distance <= allowedRadius) {
                        document.getElementById("locationStatus").innerText = "Access Granted: You are within the allowed area.";
                        document.getElementById("locationStatus").style.color = "green";
                        document.getElementById("userForm").style.display = "block";
                    } else {
                        document.getElementById("locationStatus").innerText = "Access Denied: You are outside the allowed area.";
                        document.getElementById("locationStatus").style.color = "red";
                    }
                }, () => {
                    document.getElementById("locationStatus").innerText = "Error: Unable to retrieve location.";
                });
            } else {
                document.getElementById("locationStatus").innerText = "Geolocation is not supported by this browser.";
            }
        }

        checkLocation();

        function sendDataToGoogleSheets(event) {
            event.preventDefault();
            
            const name = document.getElementById("name").value;
            const gender = document.getElementById("gender").value;
            const age = document.getElementById("age").value;
            
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxNbiisZDcc6E_QxdXXs-xgRmk2Ri0umcTzP_gd13MSLugQexXg14Bkk38Pe1ldVI7R/exec';
            
            const formData = new URLSearchParams();
            formData.append("name", name);
            formData.append("gender", gender);
            formData.append("age", age);
            
            fetch(scriptURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("Server Response:", data);
                if (data.result === "success") {
                    document.getElementById("confirmation").style.display = "block";
                    document.getElementById("error").style.display = "none";
                } else {
                    document.getElementById("error").innerText = "Error: " + data.error;
                    document.getElementById("error").style.display = "block";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("error").innerText = "Fetch error: " + error;
                document.getElementById("error").style.display = "block";
            });
        }

        document.getElementById("userForm").addEventListener("submit", sendDataToGoogleSheets);
    </script>
</body>
</html>
